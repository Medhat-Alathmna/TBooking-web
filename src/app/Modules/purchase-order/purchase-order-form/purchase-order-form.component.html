<app-loading *ngIf="loading" display="full"></app-loading>
<p-toast position="top-right"></p-toast>

<app-sidebar [display]="display" (displayChange)="onHide()">
    <div header>
        <div class="flex justify-content-between flex-wrap ">
            <div *ngIf="detailMode" class="flex align-items-center justify-content-center   ">
                <div class="flex-initial flex align-items-center justify-content-center mx-2">
                    <button pButton pRipple type="button" icon="pi pi-times" (click)="onHide()"
                        class="p-button-rounded p-button-secondary p-button-lg p-button-text btn-white "></button>
                </div>
                <div class="flex align-items-center justify-content-center border-break"></div>
                <div class="flex-initial flex align-items-center justify-content-center px-3">
                    <i class="pi pi-receipt text-100 text-3xl " [class]="'css.mr-2'|translate"></i>
                    <entity-viewer [entity]="{type:'text',title:'PO No.' | translate,value:this.po.no}"
                        [darkMode]="true"></entity-viewer>
                </div>
                <div class="flex align-items-center justify-content-center border-break"></div>
                <div class="flex-initial flex align-items-center justify-content-center px-3">
                    <i class="pi pi-calendar text-100 text-3xl " [class]="'css.mr-2'|translate"></i>
                    <entity-viewer [entity]="{type:'text',title:'CREATION DATE' | translate,value:this.po.createdAt}"
                        [darkMode]="true"></entity-viewer>
                </div>
                <div class="flex align-items-center justify-content-center border-break"></div>
                <div class="flex-initial flex align-items-center justify-content-center px-3">
                    <span [class]="'css.mr-2'|translate">
                        <i class="pi pi-tags text-100 text-3xl "></i>
                    </span>
                    <entity-viewer [entity]="{type:'text',title:'Status'| translate,value:po.status| translate}"
                        [darkMode]="true"></entity-viewer>
                </div>
                <div class="flex align-items-center justify-content-center border-break"></div>

                <div class="flex-initial flex align-items-center justify-content-center px-3">
                    <span [class]="'css.mr-2'|translate">
                        <i *ngIf="po.addedToStuck" class="pi pi-check-circle text-100 text-3xl "></i>
                        <i *ngIf="!po.addedToStuck" class="pi pi-times-circle text-100 text-3xl "></i>
                    </span>
                    <entity-viewer
                        [entity]="{type:'text',title:'Is Stocked ?'| translate,value:po.addedToStuck ?('Yes'| translate):('No'| translate) }"
                        [darkMode]="true"></entity-viewer>
                </div>
                <div class="flex align-items-center justify-content-center border-break"></div>
                <div class="flex-initial flex align-items-center justify-content-center px-3">
                    <entity-viewer
                        [entity]="{type:'user',title:'CREATED BY'|translate,value:po?.createBy?.username ,gender:po.createBy?.gender}"
                        [darkMode]="true"></entity-viewer>
                </div>
                <ng-container *ngIf="po.status=='Canceled'">
                    <div class="flex align-items-center justify-content-center border-break">
                    </div>
                    <div class="flex-initial flex align-items-center justify-content-center px-3">
                        <entity-viewer
                            [entity]="{type:'user',title:'Cancelled By'|translate,value:po?.canceledBy.username??'Unknow' ,gender:po.canceledBy?.gender}"
                            [darkMode]="true"></entity-viewer>
                    </div>
                    <div class="flex align-items-center justify-content-center border-break"></div>
                    <div class="flex-initial flex align-items-center justify-content-center px-3">
                        <i class="pi pi-calendar text-100 text-3xl " [class]="'css.mr-2'|translate"></i>
                        <entity-viewer
                            [entity]="{type:'text',title:'Cancellation Date' | translate,value:this.po.canceledAt}"
                            [darkMode]="true"></entity-viewer>
                    </div>
                </ng-container>
            </div>
            <div *ngIf="!detailMode" class="flex align-items-center justify-content-center   ">
                <div class="flex-initial flex align-items-center justify-content-center mx-2">
                    <button pButton (click)="onHide()" pRipple type="button" icon="pi pi-times"
                        class="p-button-rounded p-button-secondary p-button-lg p-button-text btn-white "></button>
                </div>
                <div class="flex align-items-center justify-content-center border-break"></div>
                <div class="flex-initial flex align-items-center justify-content-center px-3">
                    <span class="text-3xl text-white " translate>New Purchase Order</span>
                </div>
            </div>
            <div class="flex align-items-center justify-content-center mx-2 ">
                <button *ngIf="po.status == 'Draft'&&!po.addedToStuck" (click)="menu.toggle($event)" pButton pRipple
                    type="button" icon="pi pi-ellipsis-v"
                    class="p-button-rounded mr-2 p-button-secondary p-button-lg p-button-text btn-white "></button>
                <p-menu #menu id="meetingActinos" styleClass="meetingActinos" [popup]="true" appendTo="body"
                    [model]="acions"></p-menu>
                <button
                    *ngIf="(this.po.status != 'Canceled' && this.po.status !='Paid')&&permisionServices.hasPermission('PurchaseOrders', 'update')&&detailMode"
                    pButton [disabled]="!selectProducts.length || !po.vendor" pRipple type="button"
                    [label]="'Save'|translate" icon="pi pi-check " (click)="updateOptions()"
                    class="p-button-rounded p-button-outlined p-button-secondary2  p-button-lg text-btn "></button>

                <button *ngIf="!detailMode&&permisionServices.hasPermission('PurchaseOrders', 'create')" pButton pRipple
                    (click)="saveOptions()" type="button" [label]="'Save'|translate" icon="pi pi-check "
                    [disabled]="!selectProducts.length || !po.vendor"
                    class="p-button-rounded p-button-outlined p-button-secondary2  p-button-lg text-btn "></button>

            </div>
        </div>
    </div>
    <form #form="ngForm" body class="px-5 " style="margin-bottom: 6rem;">
        <div class="grid">
            <div class="col-8">
                <div class="lg:col-6 sm:col-12 ">
                    <ng-container>
                        <div class="text-lg font-semibold mb-2" translate>
                            Company
                        </div>
                    </ng-container>
                    <p-dropdown [disabled]="detailMode" appendTo="body" [filter]="true" class="text-xl"
                        [options]="vendors" (onChange)="selectVendor($event)" [(ngModel)]="po.vendor"
                        placeholder="{{'Select a'|translate}} {{'Vendor'|translate}}" name="newValue"
                        optionLabel="attributes.company"></p-dropdown>
                    <div class="grid px-3" style="justify-content: space-between">
                        <div *ngIf="po?.selectedVendor">
                            <div class="col-12">
                                <ul>
                                    <li *ngIf=" po.selectedVendor.phone"><i class="tags">{{"Vendor"| translate}} : </i>
                                        {{
                                        po.selectedVendor.name }}
                                    </li>
                                    <li *ngIf=" po.selectedVendor.phone"><i class="tags">{{"Phone"| translate}} : </i>
                                        {{
                                        po.selectedVendor.phone }}
                                    </li>
                                    <li *ngIf="po.selectedVendor.email"><i class="tags">{{"Email"| translate}} : </i>
                                        {{po.selectedVendor.email }}
                                    </li>
                                    <li *ngIf=" po.selectedVendor.address"><i class="tags">{{"Address"| translate}} :
                                        </i>
                                        {{ po.selectedVendor.address }}</li>

                                </ul>
                            </div>
                        </div>
                    </div>

                </div>


                <div class="col-12" *ngIf="po.selectedVendor">
                    <div class="col-6">
                        <button pButton pRipple type="button"
                            *ngIf="(po.status =='Draft'&& !po.addedToStuck)||!detailMode" icon="pi pi pi-plus "
                            (click)="showProductsDialog=true" [label]="'Add Product'|translate"
                            class="p-button-rounded p-button-outlined text-btn"></button>
                    </div>
                    <div *ngIf="selectProducts.length" class="mt-3 col-12">
                        <p-table [value]="selectProducts" [tableStyle]="{'width.%': 100}">
                            <ng-template pTemplate="header">
                                <tr>
                                    <th translate>Product Name</th>
                                    <th translate>Sell Price</th>
                                    <th translate>Quantity</th>
                                    <th translate>Brand</th>
                                    <th translate>Total</th>
                                    <th translate style="width: 10%;"></th>
                                </tr>
                            </ng-template>
                            <ng-template pTemplate="body" let-product let-s="rowIndex">
                                <tr>
                                    <td class=" px-2 font-bold">{{ product.name }}</td>
                                    <td>
                                        <span class=" px-2 font-bold">
                                            <input type="number" [value]="product.sellPrice" [min]="0"
                                                [ngModelOptions]="{standalone: true}" pInputText
                                                [(ngModel)]="product.sellPrice" />
                                        </span>
                                    </td>
                                    <td>
                                        <span class="  font-bold">
                                            <input type="number" name="qty{{s}}" showDelay="1000" hideDelay="1000"
                                                tooltipPosition="bottom" [min]="0" pInputText
                                                [(ngModel)]="product.qty" />
                                        </span>
                                    </td>
                                    <td>
                                        <span class="  font-bold">
                                            {{product?.brand?.name}}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="  font-bold">
                                            {{product?.sellPrice*product?.qty}} {{getCurrencySymbol(cur.code)}}
                                        </span>
                                    </td>

                                    <td>
                                        <span *ngIf="po.status =='Draft'&& !po.addedToStuck" class="  font-bold">
                                            <button pButton pRipple type="button" (click)="deleteValue(s)"
                                                icon="pi pi-trash "
                                                class="p-button-rounded p-button-danger p-button-text  "></button>
                                        </span>
                                    </td>
                                </tr>
                            </ng-template>
                        </p-table>
                    </div>
                    <div *ngIf="po.status=='Canceled'" class="w-full block pt-3">
                        <div class="text-lg font-semibold mb-2" translate>Reasons for cancellation</div>
                        <textarea [(ngModel)]="po.cancellationNote" [rows]="5" name="note" [cols]="30" pInputTextarea
                            [autoResize]="true"></textarea>
                    </div>
                </div>
            </div>
            <div *ngIf="selectProducts.length" class="col-4">
                <div class="card" style="border-style: groove;border-color: #003da85e;max-height: fit-content;">
                    <div class="flex justify-content-between align-items-center" style="margin: -5px;">
                        <button *ngIf="po.status!='Paid'" pButton pRipple type="button" (click)="openPaymentDialog()"
                            icon="pi pi-plus " style="background-color: transparent;"
                            class="p-button-rounded p-button-primary "></button>
                        <h4 translate>Payments</h4>
                        <button *ngIf="po.status!='Paid'" pButton pRipple type="button" (click)="cashAllAmount()"
                            label="100%" style="background-color: transparent;"
                            class="p-button-rounded p-button-primary fullb"></button>

                    </div>
                    <div *ngFor="let pay of payments; let i=index"
                        class="flex justify-content-between align-items-baseline mb-1"
                        style="border-style: groove;border-color: #003da85e;border-radius: 10px;">
                        <div class="flex align-items-baseline" style="padding-inline: 1rem;">
                            <h6 translate>Amount</h6>
                            <h6>: {{pay.pay}} {{getCurrencySymbol(cur.code)}}</h6>
                        </div>
                        <div class="flex align-items-center">

                            <p-tag styleClass="tag-secondary mx-2" icon="pi pi-user" showDelay="1000" hideDelay="1000"
                                tooltipPosition="bottom" pTooltip="Paid by" [value]="pay.by"></p-tag>
                            <p-tag styleClass="tag-secondary mx-2" icon="pi pi-tag" showDelay="1000" hideDelay="1000"
                                tooltipPosition="bottom" pTooltip="Payment Date" [value]="pay.date"></p-tag>
                            <button *ngIf="!pay.approved" pButton pRipple type="button" (click)="removePay(i)"
                                icon="pi pi-trash " class="p-button-rounded p-button-danger p-button-text  "></button>
                        </div>
                    </div>
                    <div class="m-0 flex justify-content-between">
                        <div class="flex align-items-baseline">
                            <h6 translate>Total Amount</h6>
                            <h6>: {{getTotalPrice().productsAmount}} {{getCurrencySymbol(cur.code)}}</h6>
                        </div>
                        <div class="flex align-items-baseline">
                            <h6 translate>Payments</h6>
                            <h6>: {{getTotalPrice().totalPayments}} {{getCurrencySymbol(cur.code)}}</h6>
                        </div>
                    </div>
                </div>
                <div class="w-full flex justify-content-center">
                      <!-- <button
    pButton
    label="Upload OCR"
    icon="pi pi-eye"
    (click)="onUploadOCR()"
    class="p-button-outlined p-button-success">
  </button> -->
                    <p-fileUpload *ngIf="!po.pic|| !po.pic.data" #fileUploader name="demo[]" [showUploadButton]="false"
                        accept="image/*" dragDropSupport="true" [chooseLabel]="'Choose' | translate" [cancelLabel]="'Cancel' | translate" rendered="true" style="width: 100%"></p-fileUpload>
                    <div *ngIf="po.pic && po.pic.data ">
                        <div *ngIf="po.status!='Paid'" style="position: relative;top: 39px;z-index: 999;padding-inline: 1rem;width: min-content;">
                            <button pButton icon="pi pi-trash delete-icon" (click)="deleteMedia(po.pic.data[0].id)"
                                class="overlay-btn"></button>
                        </div>
                        <p-image *ngIf="permisionServices.hasPermission('PurchaseOrders', 'update')" [preview]="true"
                            width="400" height="400" [imageStyle]="{'object-fit': 'contain'}"
                            [src]="imgUrl+po.pic.data[0].attributes.url"></p-image>

                    </div>

                </div>
            </div>


        </div>

    </form>
</app-sidebar>

<app-modal [(display)]="showProductsDialog" title="{{'Add Product'|translate}}" class="modal-sm">
    <div body>
        <p-dropdown appendTo="body" [filter]="true" [options]="products" [placeholder]="'Select a Product'|translate"
            (onChange)="selectedProduct($event.value)" optionLabel="name"></p-dropdown>


    </div>
    <div footer>
        <button (click)="showProductsDialog=false" pButton pRipple type="button" label=" {{'Cancel' |translate}}"
            icon='pi pi-times {{"css.mr-2"|translate}}' class="p-button-secondary p-button-outlined"></button>
    </div>
</app-modal>
<app-modal [(display)]="showPaymentDialog" class="modal-sm">
    <div body>

        <div class="lg:col-4 sm:col-6 w-full">
            <app-input #payInput (keydown)="onKeyEnterPay($event)" [focus]="true" [(ngModel)]="paymentAmount"
                type="number" name="amount" [title]="'Amount'|translate"></app-input>
        </div>

    </div>
    <div footer>
        <button (click)="showPaymentDialog=false" pButton pRipple type="button" label=" {{'Cancel' |translate}}"
            icon='pi pi-times {{"css.mr-2"|translate}}' class="p-button-secondary p-button-outlined"></button>
        <button [disabled]="paymentAmount<=0" (click)="addPayments()" pButton pRipple type="button"
            label=" {{'Add' |translate}}" class="p-button-primary"></button>
    </div>
</app-modal>
<app-modal [(display)]="showCancelltionNote" class="modal-sm">
    <div body>

        <div class="lg:col-4 sm:col-6 w-full">
            <app-input #payInput (keydown)="onKeyEnterPay($event)" [focus]="true" [(ngModel)]="po.cancellationNote"
                type="text" name="amount" [title]="'Cancellation Resone'|translate"></app-input>
        </div>

    </div>
    <div footer>
        <button (click)="showCancelltionNote=false" pButton pRipple type="button" label=" {{'Cancel' |translate}}"
            icon='pi pi-times {{"css.mr-2"|translate}}' class="p-button-secondary p-button-outlined"></button>
        <button [disabled]="!po.cancellationNote" (click)="cancelPO()" pButton pRipple type="button"
            label=" {{'Apply' |translate}}" class="p-button-primary"></button>
    </div>
</app-modal>

<!-- ✅ Modal لإضافة مورد جديد -->
<app-modal
  [(display)]="showVendorModal"
  [title]="'Add New Vendor' | translate"
  icon="pi pi-user-plus"
>
  <div body>
    <app-input
      [(ngModel)]="newVendorName"
      name="newVendorName"
      [title]="'Vendor Name' | translate"
      placeholder="Enter vendor name"
      [focus]="true">
    </app-input>
  </div>

  <div footer>
    <button
      pButton
      label="{{ 'Cancel' | translate }}"
      icon="pi pi-times"
      class="p-button-secondary p-button-outlined"
      (click)="showVendorModal = false">
    </button>

    <button
      pButton
      label="{{ 'Save' | translate }}"
      icon="pi pi-check"
      class="p-button-success"
      [disabled]="!newVendorName"
      (click)="confirmAddVendor()">
    </button>
  </div>
</app-modal>
