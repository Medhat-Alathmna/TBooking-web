<app-loading *ngIf="loading" display="full"></app-loading>
<app-sidebar [display]="display" (displayChange)="onHide()">
    <div header>
        <div class="flex justify-content-between flex-wrap ">
            <div class="flex align-items-center justify-content-center   ">
                <div class="flex-initial flex align-items-center justify-content-center mx-2">
                    <button pButton pRipple type="button" icon="pi pi-times" (click)="onHide()"
                        class="p-button-rounded p-button-secondary p-button-lg p-button-text btn-white "></button>
                </div>
                <div class="flex align-items-center justify-content-center border-break"></div>
                <div class="flex-initial flex align-items-center justify-content-center px-3">
                    <i class="pi pi-calendar text-100 text-3xl " [class]="'css.mr-2'|translate"></i>
                    <entity-viewer
                        [entity]="{type:'text',title:'CREATION DATE' | translate,value:this.selectedOrder.attributes.createdAt}"
                        [darkMode]="true"></entity-viewer>
                </div>
                <div class="flex align-items-center justify-content-center border-break"></div>
                <div class="flex-initial flex align-items-center justify-content-center px-3">
                    <span [class]="'css.mr-2'|translate">
                        <i class="pi pi-tags text-100 text-3xl "></i>
                    </span>
                    <entity-viewer
                        [entity]="{type:'text',title:'Status'| translate,value:selectedOrder.attributes.status|translate}"
                        [darkMode]="true"></entity-viewer>
                </div>
                <div class="flex align-items-center justify-content-center border-break"></div>
                <div class="flex-initial flex align-items-center justify-content-center px-3">
                    <entity-viewer
                        [entity]="{type:'user',title:'Ordered BY'|translate,value:selectedOrder.attributes.appointment.data.attributes?.appoBy}"
                        [darkMode]="true"></entity-viewer>
                </div>
            </div>
            <div class="flex align-items-center justify-content-center mx-2 ">
                <button *ngIf="selectedOrder.attributes.status != 'Canceled'" (click)="tt.toggle($event)" pButton
                    pRipple type="button" icon="pi pi-whatsapp"
                    class="p-button-rounded mr-2 p-button-secondary p-button-lg p-button-text btn-white "></button>
                <p-menu #tt [popup]="true" appendTo="body" [model]="notfiItems"></p-menu>

                <button *ngIf="selectedOrder.attributes.status != 'Canceled'" (click)="menu.toggle($event)" pButton
                    pRipple type="button" icon="pi pi-ellipsis-v"
                    class="p-button-rounded mr-2 p-button-secondary p-button-lg p-button-text btn-white "></button>
                <p-menu #menu id="meetingActinos" styleClass="meetingActinos" [popup]="true" appendTo="body"
                    [model]="acions"></p-menu>
                <button pButton
                    *ngIf="selectedOrder.attributes.status == 'Draft' || selectedOrder.attributes.status == 'Unpaid'"
                    pRipple type="button" [label]="'Save'|translate" icon="pi pi-check " (click)="updateOrder()"
                    class="p-button-rounded p-button-outlined p-button-secondary2  p-button-lg text-btn "></button>
            </div>
        </div>
    </div>
    <form #form="ngForm" body class="px-5 ">
        <div class="grid ">
            <div class="col-12 pb-4">
                <span class="text-3xl ont-semibold font-bold" translate>Customer Details </span>
            </div>
            <div class="lg:col-4 sm:col-6">
                <app-input [disabled]="true"
                    [(ngModel)]="selectedOrder.attributes.appointment.data.attributes.customer.firstName"
                    name="firstName" [title]="'First Name'|translate" [required]="true"></app-input>
            </div>
            <div class="lg:col-4 sm:col-6 ">
                <app-input [disabled]="true"
                    [(ngModel)]="selectedOrder.attributes.appointment.data.attributes.customer.middleName"
                    name="middleName" [title]="'Middle Namee'|translate" [required]="true"></app-input>
            </div>
            <div class="lg:col-4 sm:col-6 ">
                <app-input [disabled]="true"
                    [(ngModel)]="selectedOrder.attributes.appointment.data.attributes.customer.lastName" name="lastName"
                    [title]="'Last Name'|translate" [required]="true"></app-input>
            </div>
            <div class="lg:col-4 sm:col-6 ">
                <app-input-mask [disabled]="true" name="phone"
                    [(ngModel)]="selectedOrder.attributes.appointment.data.attributes.phone" [required]="true"
                    [title]="'Phone'|translate"></app-input-mask>
            </div>
            <div class="lg:col-4 sm:col-6 ">
                <app-input [disabled]="true" [(ngModel)]="selectedOrder.attributes.appointment.data.attributes.address"
                    name="address" [title]="'Address'|translate"></app-input>
            </div>
            <div class="lg:col-4 sm:col-6 ">
                <app-input [disabled]="true" [(ngModel)]="selectedOrder.attributes.appointment.data.attributes.deposit"
                    name="deposit" title="{{'Deposit'|translate}} /   {{getCurrencySymbol(cur)}}" type="number"></app-input>
            </div>
        </div>
        <div>
            <div class="col-12 py-4">
                <span class="text-3xl ont-semibold font-bold" translate>
                    Appointment Details </span>
            </div>
            <div class="grid ">
                <div class="col-6">
                    <div>
                        <app-input [(ngModel)]="selectedOrder.attributes.appointment.data.attributes.number"
                            name="title" [title]="'Appointment No.'|translate" [required]="true"
                            [disabled]="true"></app-input>
                    </div>
                    <div class="my-1">
                        <app-calender [(ngModel)]="selectedOrder.attributes.appointment.data.attributes.fromDate"
                            [stepMinute]='30' [showTime]="true" [disabled]="true" [required]="true" name="fromDate"
                            showIcon="true" [title]="'Start Date'|translate"></app-calender>
                    </div>
                    <div>
                        <app-calender [(ngModel)]="selectedOrder.attributes.appointment.data.attributes.toDate"
                            [stepMinute]='30' [timeOnly]="true" [disabled]="true" [showTime]="true" [required]="true"
                            name="toDate" showIcon="true" [title]="'Finish Date'|translate"></app-calender>
                    </div>
                    <!-- <div  class="block my-1">
                        <ng-container>
                            <div class="text-lg font-semibold mb-2" translate>
                                Employee
                            </div>
                        </ng-container>
                        <p-button  [label]="selectedOrder.attributes.appointment.data.attributes.employee?.username" [style]="{'width': '46vw'}"
                          styleClass="p-button-outlined p-button-success"></p-button>

                    </div> -->
                </div>
                <div [class]="lang=='en'?'col-6 leftLine':'leftRight col-6'">
                    <div class="flex justify-content-between flex-wrap mx-2 mt-2">
                        <div class="flex align-items-center justify-content-center  ">
                            <div class="text-2xl font-semibold " translate>
                                Services
                            </div>
                        </div>

                    </div>
                 
                    <div class="block my-1" *ngFor="let item of selectedOrder?.attributes.employee;let i =index ">
                        <ng-container>
                            <div class="text-lg font-semibold mb-2" translate>
                                Employee
                            </div>
                        </ng-container>
                        <div class="flex">
                            <div class="block" style="width: 75%;">
                                <p-button *ngIf="item" [label]="item?.username" [style]="{'width': '50%','cursor':'default'}"
                                    (click)="employeeMode=false"
                                    styleClass="p-button-outlined p-button-success"></p-button>
                            </div>
                           
                        </div>
                        <div *ngIf="item.services" class="mt-3 mx-2">
                            <div *ngFor="let ser of item.services;let c =index " class="flex justify-content-between flex-wrap mb-2">
                                <div class=" text-base font-semibold justify-content-between"
                                    style="display: flex;align-items: center;justify-content: space-around;width: 23vw">
                                    <div class="pi pi-circle-fill text-primary text-xs pt-2"></div>
                                    <span class="  font-bold "> {{ser[lang]}} </span>
                                    <span class="  font-bold">
                                        <input type="number" disabled name="price{{i}}{{c}}" pInputText [(ngModel)]="ser.price" />

                                    </span>
                                </div>
                             
                            </div>
                            <p-divider *ngIf="item.services.length"></p-divider>
                        </div>
                    </div>
                    <div *ngIf="selectedOrder?.attributes?.products?.length" class="mt-3">
                        <p-table [value]="selectedOrder?.attributes?.products" [tableStyle]="{'width.%': 100}">
                            <ng-template pTemplate="header">
                                <tr>
                                    <th translate>Product Name</th>
                                    <th translate>Price</th>
                                    <th translate>Quantity</th>
                                    <th translate>Brand</th>
                                    <th translate>Total</th>
                                </tr>
                            </ng-template>
                            <ng-template pTemplate="body" let-product let-s="rowIndex">
                                <tr>
                                    <td>{{ product.name }}</td>
                                    <td>
                                        <span class=" px-2 font-bold">
                                            <input disabled type="number" [value]="product.price"
                                                [ngModelOptions]="{standalone: true}" pInputText
                                                [(ngModel)]="product.price" />
                                        </span>
                                    </td>
                                    <td>
                                        <span class="  font-bold">
                                            <input disabled type="number" name="qty{{s}}"
                                                [pTooltip]="product.stocks ?' Stocks: ' +product.stocks:null"
                                                showDelay="1000" hideDelay="1000" tooltipPosition="bottom"
                                                (ngModelChange)="checkStock()" [max]="product.stocks" pInputText
                                                [(ngModel)]="product.qty" />
                                        </span>
                                    </td>
                                    <td>
                                        <span class="  font-bold">
                                            {{product?.brand?.name}}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="  font-bold">
                                            {{product.price*product.qty}}   {{getCurrencySymbol(cur)}}
                                        </span>
                                    </td>


                                </tr>
                            </ng-template>
                        </p-table>
                    </div>

                    <div class="text-xl text-primary font-bold mt-3 col-12" style="display: table-footer-group">
                        <table>
                            <tr>
                                <th class="px-5">{{'Services Price'|translate}}:</th>
                                <th>{{getTotalPrice().products}}  {{getCurrencySymbol(cur)}}</th>
                            </tr>
                            <tr>
                                <th class="px-5 py-2" translate> {{'Deposit'|translate}}:</th>
                                <th>{{selectedOrder.attributes.appointment.data.attributes.deposit}}  {{getCurrencySymbol(cur)}}</th>
                            </tr>
                            <p-divider></p-divider>
                            <tr >
                                <th class="px-5 py-2" translate> {{'Discount'|translate}}:</th>
                                <th>
                                    <span *ngIf="discountMode =='type'" >
                                        <i class="pointer pi pi-money-bill" 
                                            (click)="discountMode='price';cashMode=false;selectedOrder.discountType='cash'">
                                        </i>
                                        <span class="px-2">|</span>
                                        <i class="pointer pi pi-percentage"
                                            (click)="discountMode='price';cashMode=false;selectedOrder.discountType='percent'"></i>
                                    </span>

                                    <span *ngIf="discountMode =='price'">
                                        <p-inputNumber [min]="0" *ngIf="selectedOrder.discountType == 'cash'" [disabled]="selectedOrder.attributes.status==='Paid'"
                                            name="discount" [(ngModel)]="selectedOrder.discount"
                                            (onFocus)="$event.target.select()" (keydown)="onKeyEnter($event)"
                                            mode="decimal" [minFractionDigits]="2"></p-inputNumber>

                                        <p-inputNumber [min]="0" *ngIf="selectedOrder.discountType == 'percent'" [disabled]="selectedOrder.attributes.status==='Paid'"
                                            prefix="%" name="discount" (keydown)="onKeyEnter($event)"
                                            [(ngModel)]="selectedOrder.discount" [max]="100"></p-inputNumber>
                                    </span>
                                    <span *ngIf="discountMode =='show'" (click)="discountMode ='type'">
                                        <span *ngIf="selectedOrder.discountType =='cash'">
                                            {{selectedOrder.discount}}  {{getCurrencySymbol(cur)}}
                                        </span>
                                        <span *ngIf="selectedOrder.discountType =='percent'">
                                            {{selectedOrder.discount}} %
                                        </span>
                                    </span>
                                </th>
                            </tr>
                            <tr>
                                <th class="px-5 py-2" translate> {{'Paid'|translate}}:</th>
                                <th>
                                    <span class="pointer" *ngIf="!cashMode" (click)="cashMode=true">
                                        {{selectedOrder.cash}}  {{getCurrencySymbol(cur)}}</span>
                                    <span *ngIf="cashMode">
                                        <input [(ngModel)]="selectedOrder.cash" type="number" [disabled]="selectedOrder.attributes.status==='Paid'"
                                            (keydown)="onKeyEnter($event,'cash')"
                                            placeholder="{{'Enter'|translate}} Cash" name="Cash" pInputText />
                                    </span>
                                </th>
                            </tr>
                            <p-divider></p-divider>
                            <tr>
                                <th class="px-5 text-danger">{{'Unpaid'|translate}}:</th>
                                <th>{{getTotalPrice().total | number : '1.2-2'}}  {{getCurrencySymbol(cur)}}</th>
                            </tr>
                        </table>


                    </div>
                    <app-pay-by [ngModelOptions]="{standalone: true}" [disabled]="selectedOrder.attributes.status==='Paid'" [payByMode]="payByMode" [(ngModel)]="selectedOrder.pay_by"></app-pay-by>

                </div>
            </div>


            <div class="col-12">
                <app-text-area name="notes" [(ngModel)]="selectedOrder.attributes.appointment.data.attributes.notes"
                    [title]="'Notes'|translate"></app-text-area>
            </div>
        </div>

    </form>


</app-sidebar>